---
- name: SwarmGLPI Full Deployment
  hosts: localhost
  gather_facts: true

  vars_files:
    - vars/secrets.yml

  tasks:
    # ===================
    # TERRAFORM
    # ===================
    - name: Initialize Terraform
      command: terraform init
      args:
        chdir: "{{ playbook_dir }}/../terraform"
      changed_when: false

    - name: Apply Terraform infrastructure
      command: terraform apply -auto-approve
      args:
        chdir: "{{ playbook_dir }}/../terraform"
      register: terraform_result
      changed_when: "'Apply complete' in terraform_result.stdout"

    # ===================
    # DOCKER STACK
    # ===================
    - name: Deploy Docker Swarm stack
      command: docker stack deploy -c {{ playbook_dir }}/../docker-stack.yml glpi
      register: stack_result
      changed_when: "'Creating' in stack_result.stdout"

    - name: Wait for services to start
      shell: docker service ls
      register: services_status
      until: "'0/1' not in services_status.stdout and '0/3' not in services_status.stdout"
      retries: 30
      delay: 3
      changed_when: false

    # ===================
    # SSL CERTIFICATES
    # ===================
    - name: Ensure certificate directories exist
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - /tmp/glpi-setup
        - /tmp/glpi-setup/live/{{ glpi_domain }}

    - name: Generate self-signed SSL certificate
      command: >
        openssl req -x509 -nodes -days 365 -newkey rsa:2048
        -keyout /tmp/glpi-setup/live/{{ glpi_domain }}/privkey.pem
        -out /tmp/glpi-setup/live/{{ glpi_domain }}/fullchain.pem
        -subj "/CN={{ glpi_domain }}"
      args:
        creates: /tmp/glpi-setup/live/{{ glpi_domain }}/fullchain.pem
      when: use_self_signed_cert | default(true)

    - name: Copy certificates to Docker volume
      shell: |
        tar -C /tmp/glpi-setup -cf - live | docker run --rm -i -v glpi_certs:/certs alpine tar -C /certs -xf -
      changed_when: true

    # ===================
    # NGINX CONFIG
    # ===================
    - name: Copy nginx configuration to Docker volume
      shell: |
        cat {{ playbook_dir }}/../nginx/nginx.conf | docker run --rm -i -v glpi_nginx_conf:/conf alpine sh -c 'cat > /conf/default.conf'
      changed_when: true

    - name: Restart nginx to apply configuration
      command: docker service update --force glpi_nginx
      changed_when: true

    # ===================
    # DATABASE
    # ===================
    - name: Wait for MariaDB to be ready
      shell: |
        docker exec $(docker ps -q -f name=glpi_mariadb) mysqladmin ping -h localhost -u root --password='{{ glpi_db_root_password }}'
      register: db_ready
      until: db_ready.rc == 0
      retries: 30
      delay: 5
      changed_when: false

    - name: Set GLPI database user password
      shell: |
        docker exec $(docker ps -q -f name=glpi_mariadb) mysql -u root -p'{{ glpi_db_root_password }}' -e "ALTER USER '{{ glpi_db_user }}'@'%' IDENTIFIED BY '{{ glpi_db_password }}'; FLUSH PRIVILEGES;"
      changed_when: true

    # ===================
    # GLPI SETUP
    # ===================
    - name: Wait for GLPI container to be ready
      shell: |
        docker exec $(docker ps -q -f name=glpi_glpi) test -f /var/www/glpi/bin/console
      register: glpi_ready
      until: glpi_ready.rc == 0
      retries: 30
      delay: 3
      changed_when: false

    - name: Check if GLPI is already installed
      shell: |
        docker exec $(docker ps -q -f name=glpi_glpi) test -f /var/glpi/config/config_db.php
      register: glpi_installed
      ignore_errors: true
      changed_when: false

    - name: Install GLPI via CLI
      shell: |
        docker exec $(docker ps -q -f name=glpi_glpi) php /var/www/glpi/bin/console db:install \
          --db-host=mariadb \
          --db-port=3306 \
          --db-name={{ glpi_db_name }} \
          --db-user={{ glpi_db_user }} \
          --db-password='{{ glpi_db_password }}' \
          --default-language=fr_FR \
          --no-interaction \
          --force
      when: glpi_installed.rc != 0
      register: glpi_install_result

    - name: Remove GLPI install directory for security
      shell: |
        docker exec $(docker ps -q -f name=glpi_glpi) rm -rf /var/www/glpi/install
      ignore_errors: true
      changed_when: true

    # ===================
    # FINAL STATUS
    # ===================
    - name: Display deployment status
      debug:
        msg: |
          ============================================
          SwarmGLPI déployé avec succès !
          ============================================

          Accès : https://{{ glpi_domain }}

          Identifiants GLPI par défaut :
          - glpi / glpi (super-admin)
          - tech / tech (technicien)
          - normal / normal (utilisateur)
          - post-only / postonly (post-only)

          IMPORTANT : Changez les mots de passe par défaut !
          ============================================
